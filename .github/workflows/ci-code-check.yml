# CI 独立配置文件：仅负责 Python 代码批量检查，不涉及任何产物构建
name: CI - Python Code Check (独立版)

# 触发条件：1. 提交代码到 main 分支 2. 发起 PR 到 main 分支 3. 手动触发（方便测试）
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 手动触发开关，在 GitHub Actions 页面可手动点击运行

# 仅定义一个检查任务，确保代码合格
jobs:
  code-quality-check:
    # 运行环境：选择 Ubuntu（轻量、快速，仅做检查无需对应产物平台）
    runs-on: ubuntu-latest
    steps:
      # 步骤 1：拉取仓库完整代码（包含所有已有和新增 .py 文件）
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 步骤 2：配置 Python 环境（匹配你的项目 Python 版本）
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # 步骤 3：安装项目依赖 + 代码检查工具
      - name: Install dependencies and check tools
        run: |
          python -m pip install --upgrade pip
          # 安装项目业务依赖
          pip install -r requirements.txt
          # 安装代码检查工具：flake8（语法/规范）、pytest（单元测试，可选）
          pip install flake8 pytest

      # 步骤 4：批量检查所有 .py 代码规范（递归扫描，自动包含新增文件）
      - name: Batch check code style with flake8
        run: |
          flake8 . \
            --exclude=__pycache__,venv,env \ # 排除无关目录
            --count \
            --select=E9,F63,F7,F82 \ # 仅检查严重语法错误（新手友好）
            --show-source \
            --statistics

      # 步骤 5：批量运行 scripts 目录下所有 .py 脚本（验证脚本可执行性）
      - name: Batch run scripts directory .py files
        run: |
          cd scripts
          for py_file in *.py; do
            # 忽略 __init__.py（空文件无运行意义）
            if [ "$py_file" != "__init__.py" ]; then
              echo "=== 正在运行脚本：$py_file ==="
              python "$py_file"
              # 若脚本运行失败，立即终止 CI 流程并标红
              if [ $? -ne 0 ]; then
                echo "❌ 脚本 $py_file 运行失败！"
                exit 1
              fi
              echo "✅ 脚本 $py_file 运行成功！"
            fi
          done